generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * =========================
 * Core enums
 * =========================
 */
enum Role {
  HOMEOWNER
  PRO
  ADMIN
}

enum ProStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ProType {
  REALTOR
  INSPECTOR
  CONTRACTOR
}

enum AccessLevel {
  OWNER
  VIEW
  COMMENT
  EDIT
}

enum AttachmentVisibility {
  OWNER
  HOME
  PUBLIC
}

/**
 * =========================
 * Connection & workflow enums
 * =========================
 */

enum EstablishedVia {
  VERIFIED_WORK
  INVITATION
  MANUAL
}

enum ConnectionStatus {
  PENDING
  ACTIVE
  ARCHIVED
}

enum InvitationType {
  HOMEOWNER_TO_CONTRACTOR
  CONTRACTOR_TO_HOMEOWNER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  CANCELLED
  EXPIRED
}

enum ThreadStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  DECLINED
  EXPIRED
}

enum HomeSystemType {
  ROOF
  HVAC
  PLUMBING
  ELECTRICAL
  EXTERIOR
  INTERIOR
  APPLIANCE
  OTHER
}

enum NotificationChannel {
  EMAIL
  PUSH
  INAPP
}

// FOR WORK SUBMISSIONS (contractor documenting past work)
enum WorkSubmissionStatus {
  PENDING_REVIEW // Homeowner needs to review
  DOCUMENTED_UNVERIFIED // Alternative pending state
  DOCUMENTED // Documented, awaiting review
  APPROVED // Homeowner approved
  REJECTED // Homeowner rejected
  DISPUTED // Homeowner disputes details
  EXPIRED // Submission expired
}

// FOR JOB REQUESTS (homeowner requesting future work)
enum JobRequestStatus {
  PENDING // Waiting for contractor response
  QUOTED // Contractor sent quote
  ACCEPTED // Homeowner accepted quote
  DECLINED // Declined by either party
  IN_PROGRESS // Work in progress
  COMPLETED // Work completed
  CANCELLED // Request cancelled
}

enum JobRequestUrgency {
  LOW
  NORMAL
  HIGH
  EMERGENCY
}

/**
 * =========================
 * Core models
 * =========================
 */

model User {
  id            String    @id @default(cuid())
  email         String    @unique @db.Citext
  passwordHash  String?
  name          String?
  image         String?
  emailVerified DateTime?

  role      Role       @default(HOMEOWNER)
  proStatus ProStatus?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  accounts Account[]
  sessions Session[]

  // Ownership and access
  homes      Home[]          @relation("HomeOwner")
  ownerships HomeOwnership[]
  access     HomeAccess[]

  // Content authored
  records            Record[]   @relation("RecordCreator")
  reminders          Reminder[] @relation("ReminderCreator")
  warrantiesCreated  Warranty[] @relation("WarrantyCreator")
  warrantiesVerified Warranty[] @relation("WarrantyVerifier")

  // Pro profile
  proProfile ProProfile?

  // Uploads
  attachmentsUploaded Attachment[] @relation("AttachmentUploader")

  // Connection invitations (email-based)
  invitationsSent Invitation[] @relation("InvitationsSent")

  // Messaging
  messagesSent Message[]     @relation("MessagesSent")
  messageReads MessageRead[]

  // Connections
  connectionsAsHomeowner  Connection[] @relation("ConnectionHomeowner")
  connectionsAsContractor Connection[] @relation("ConnectionContractor")
  connectionsAsRealtor    Connection[] @relation("ConnectionRealtor")
  connectionsAsInspector  Connection[] @relation("ConnectionInspector")

  // Work submissions (contractor documents past work)
  workSubmissionsSent         WorkSubmission[] @relation("WorkSubmissionsSent")
  workSubmissionsAsContractor WorkSubmission[] @relation("ContractorWorkSubmissions")
  workSubmissionsAsHomeowner  WorkSubmission[] @relation("HomeownerWorkSubmissions")

  // Job requests (homeowner requests future work)
  sentJobRequests     JobRequest[] @relation("HomeownerJobRequests")
  receivedJobRequests JobRequest[] @relation("ContractorJobRequests")

  // Work records
  workRecordsAsContractor WorkRecord[] @relation("ContractorWorkRecords")
  workRecordsApproved     WorkRecord[] @relation("WorkRecordApprovals")

  // Last viewed home
  lastHomeId String?
  lastHome   Home?   @relation("UserLastHome", fields: [lastHomeId], references: [id])

  // Audit / Notifications
  auditLogs     AuditLog[]     @relation("AuditActor")
  notifications Notification[]
  Record        Record[]

  @@index([email])
  @@index([role])
  @@index([proStatus])
  @@index([createdAt])
}

model Home {
  id           String  @id @default(cuid())
  address      String
  addressLine2 String?
  city         String
  state        String
  zip          String
  postalCode   String?
  county       String?
  country      String? @default("US")

  normalizedAddress String?

  latitude  Decimal? @db.Decimal(9, 6)
  longitude Decimal? @db.Decimal(9, 6)
  apn       String?
  photos    String[] @default([])
  meta      Json?

  auditLogs AuditLog[] @relation("AuditHome")

  ownerId String?
  owner   User?   @relation("HomeOwner", fields: [ownerId], references: [id])

  // Lifecycle
  ownerships  HomeOwnership[]
  records     Record[]
  reminders   Reminder[]
  warranties  Warranty[]
  attachments Attachment[]
  access      HomeAccess[]
  systems     HomeSystem[]

  // Connections & collaboration
  connections Connection[]
  invitations Invitation[]
  threads     Thread[]
  quotes      Quote[]

  // Work submissions (past work documentation)
  workSubmissions WorkSubmission[]
  workRecords     WorkRecord[]

  // Job requests (future work requests)
  jobRequests JobRequest[]

  // Back relation for lastHome
  lastForUsers User[] @relation("UserLastHome")

  // Soft-delete/archival
  archivedAt DateTime?
  deletedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@index([city, state])
  @@index([updatedAt])
  @@index([apn])
}

model HomeOwnership {
  id        String    @id @default(cuid())
  homeId    String
  userId    String
  startedAt DateTime  @default(now())
  endedAt   DateTime?

  home Home @relation(fields: [homeId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([homeId, startedAt])
  @@index([userId, startedAt])
}

model HomeSystem {
  id     String         @id @default(cuid())
  homeId String
  type   HomeSystemType
  name   String?
  notes  String?        @db.Text

  home    Home     @relation(fields: [homeId], references: [id], onDelete: Cascade)
  records Record[]

  @@index([homeId, type])
}

model Record {
  id        String   @id @default(cuid())
  homeId    String
  title     String
  note      String?
  date      DateTime
  kind      String?
  createdBy String?
  vendor    String?
  cost      Decimal? @db.Decimal(12, 2)

  verifiedBy String?
  verifiedAt DateTime?

  systemId String?

  home     Home        @relation(fields: [homeId], references: [id], onDelete: Cascade)
  creator  User?       @relation("RecordCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  verifier User?       @relation(fields: [verifiedBy], references: [id], onDelete: SetNull)
  system   HomeSystem? @relation(fields: [systemId], references: [id], onDelete: SetNull)

  attachments Attachment[]
  threads     Thread[]

  approvedWorkRecord WorkRecord? @relation("ApprovedWorkRecord")

  archivedAt DateTime?
  deletedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([homeId, date])
  @@index([createdBy])
  @@index([homeId, kind, date])
}

model Attachment {
  id     String @id @default(cuid())
  homeId String

  recordId         String?
  reminderId       String?
  warrantyId       String?
  messageId        String?
  workRecordId     String?
  jobRequestId     String?
  workSubmissionId String?

  key        String
  url        String
  filename   String
  mimeType   String
  size       BigInt
  uploadedBy String?
  createdAt  DateTime @default(now())

  visibility  AttachmentVisibility @default(OWNER)
  notes       String?
  containsPII Boolean              @default(false)

  storageProvider String    @default("s3")
  checksum        String?
  scannedAt       DateTime?
  scanStatus      String?
  publicToken     String?   @unique
  publicExpiresAt DateTime?

  archivedAt DateTime?
  deletedAt  DateTime?

  home           Home            @relation(fields: [homeId], references: [id], onDelete: Cascade)
  record         Record?         @relation(fields: [recordId], references: [id], onDelete: SetNull)
  reminder       Reminder?       @relation(fields: [reminderId], references: [id], onDelete: SetNull)
  warranty       Warranty?       @relation(fields: [warrantyId], references: [id], onDelete: SetNull)
  message        Message?        @relation(fields: [messageId], references: [id], onDelete: SetNull)
  workRecord     WorkRecord?     @relation("WorkRecordAttachments", fields: [workRecordId], references: [id], onDelete: SetNull)
  uploader       User?           @relation("AttachmentUploader", fields: [uploadedBy], references: [id], onDelete: SetNull)
  jobRequest     JobRequest?     @relation("JobRequestAttachments", fields: [jobRequestId], references: [id], onDelete: Cascade)
  workSubmission WorkSubmission? @relation("WorkSubmissionAttachments", fields: [workSubmissionId], references: [id], onDelete: Cascade)

  @@index([homeId])
  @@index([recordId])
  @@index([reminderId])
  @@index([warrantyId])
  @@index([workRecordId])
  @@index([jobRequestId])
  @@index([workSubmissionId])
  @@index([messageId])
  @@index([uploadedBy])
  @@index([checksum])
  @@index([homeId, visibility, createdAt])
}

model Reminder {
  id        String   @id @default(cuid())
  homeId    String
  title     String
  dueAt     DateTime
  note      String?
  createdBy String?

  home    Home  @relation(fields: [homeId], references: [id], onDelete: Cascade)
  creator User? @relation("ReminderCreator", fields: [createdBy], references: [id], onDelete: SetNull)

  attachments Attachment[]

  archivedAt DateTime?
  deletedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([homeId, dueAt])
  @@index([createdBy])
  @@index([homeId, dueAt, createdBy])
}

model Warranty {
  id        String    @id @default(cuid())
  homeId    String
  item      String
  provider  String?
  policyNo  String?
  expiresAt DateTime?
  note      String?

  createdBy  String?
  createdAt  DateTime  @default(now())
  verifiedBy String?
  verifiedAt DateTime?

  archivedAt DateTime?
  deletedAt  DateTime?

  home     Home  @relation(fields: [homeId], references: [id], onDelete: Cascade)
  creator  User? @relation("WarrantyCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  verifier User? @relation("WarrantyVerifier", fields: [verifiedBy], references: [id], onDelete: SetNull)

  attachments Attachment[]

  @@index([homeId, expiresAt])
  @@index([createdBy])
  @@index([verifiedBy])
}

/**
 * =========================
 * Pro application/profile
 * =========================
 */

model ProProfile {
  id        String  @id @default(cuid())
  userId    String  @unique
  type      ProType
  company   String?
  licenseNo String?
  website   String?
  phone     String?

  businessName  String?
  bio           String?  @db.Text
  logo          String?
  specialties   String[] @default([])
  serviceAreas  String[] @default([])
  verified      Boolean  @default(false)
  rating        Float?
  completedJobs Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([verified])
  @@index([userId])
}

/**
 * =========================
 * Sharing / access control
 * =========================
 */

model HomeAccess {
  id         String      @id @default(cuid())
  homeId     String
  userId     String
  role       AccessLevel
  migratedAt DateTime?

  home Home @relation(fields: [homeId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([homeId, userId], name: "homeId_userId")
  @@index([homeId])
  @@index([userId])
}

/**
 * =========================
 * Contractor/Connection System
 * =========================
 */

model Connection {
  id           String           @id @default(cuid())
  homeownerId  String
  contractorId String?
  realtorId    String?
  inspectorId  String?
  homeId       String
  status       ConnectionStatus @default(PENDING)
  invitedBy    String
  invitedAt    DateTime         @default(now())
  acceptedAt   DateTime?

  establishedVia EstablishedVia?
  sourceRecordId String?

  verifiedWorkCount Int       @default(0)
  totalSpent        Decimal   @default(0) @db.Decimal(12, 2)
  lastWorkDate      DateTime?

  notes String?
  tags  String[] @default([])

  homeowner  User  @relation("ConnectionHomeowner", fields: [homeownerId], references: [id], onDelete: Cascade)
  contractor User? @relation("ConnectionContractor", fields: [contractorId], references: [id], onDelete: Cascade)
  realtor    User? @relation("ConnectionRealtor", fields: [realtorId], references: [id], onDelete: Cascade)
  inspector  User? @relation("ConnectionInspector", fields: [inspectorId], references: [id], onDelete: Cascade)
  home       Home  @relation(fields: [homeId], references: [id], onDelete: Cascade)

  messages    Message[]
  threads     Thread[]
  quotes      Quote[]
  jobRequests JobRequest[]

  archivedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([homeownerId, contractorId, homeId])
  @@index([homeownerId])
  @@index([contractorId])
  @@index([homeId])
  @@index([status])
}

model Invitation {
  id           String           @id @default(cuid())
  invitedBy    String
  invitedEmail String
  invitedName  String?
  homeId       String?
  role         Role
  status       InvitationStatus @default(PENDING)
  token        String           @unique @default(cuid())
  message      String?          @db.Text

  inviter User  @relation("InvitationsSent", fields: [invitedBy], references: [id], onDelete: Cascade)
  home    Home? @relation(fields: [homeId], references: [id], onDelete: SetNull)

  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([invitedEmail])
  @@index([token])
  @@index([status])
  @@index([invitedBy])
}

model Message {
  id           String   @id @default(cuid())
  connectionId String
  senderId     String
  content      String   @db.Text
  createdAt    DateTime @default(now())

  readAt DateTime?

  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  sender     User       @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)

  attachments Attachment[]
  reads       MessageRead[]

  @@index([connectionId, createdAt])
  @@index([senderId])
}

model MessageRead {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  readAt    DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([userId, readAt])
}

model Thread {
  id              String       @id @default(cuid())
  connectionId    String
  homeId          String
  subject         String
  status          ThreadStatus @default(ACTIVE)
  relatedRecordId String?

  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  home       Home       @relation(fields: [homeId], references: [id], onDelete: Cascade)
  record     Record?    @relation(fields: [relatedRecordId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([connectionId])
  @@index([homeId])
  @@index([status])
}

/**
 * =========================
 * Job Request System (FUTURE WORK)
 * Homeowner requests work/quotes from contractor
 * =========================
 */

model JobRequest {
  id String @id @default(cuid())

  connectionId String
  homeId       String
  homeownerId  String
  contractorId String

  title       String
  description String            @db.Text
  category    String?
  urgency     JobRequestUrgency @default(NORMAL)

  budgetMin   Decimal?  @db.Decimal(12, 2)
  budgetMax   Decimal?  @db.Decimal(12, 2)
  desiredDate DateTime?

  photos      String[]     @default([])
  attachments Attachment[] @relation("JobRequestAttachments")

  status JobRequestStatus @default(PENDING)

  contractorNotes String?   @db.Text
  respondedAt     DateTime?

  quoteId      String?     @unique
  quote        Quote?      @relation("JobRequestQuote", fields: [quoteId], references: [id], onDelete: SetNull)
  workRecordId String?     @unique
  workRecord   WorkRecord? @relation("JobRequestRecord", fields: [workRecordId], references: [id], onDelete: SetNull)

  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  home       Home       @relation(fields: [homeId], references: [id], onDelete: Cascade)
  homeowner  User       @relation("HomeownerJobRequests", fields: [homeownerId], references: [id], onDelete: Cascade)
  contractor User       @relation("ContractorJobRequests", fields: [contractorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([connectionId])
  @@index([homeId])
  @@index([homeownerId])
  @@index([contractorId])
  @@index([status])
  @@index([createdAt])
}

/**
 * =========================
 * Work Submission System (PAST WORK DOCUMENTATION)
 * Contractor submits completed work for homeowner approval
 * =========================
 */

model WorkSubmission {
  id String @id @default(cuid())

  invitedBy String
  inviter   User   @relation("WorkSubmissionsSent", fields: [invitedBy], references: [id], onDelete: Cascade)

  invitationType InvitationType @default(CONTRACTOR_TO_HOMEOWNER)

  homeAddress String
  homeCity    String?
  homeState   String?
  homeZip     String?
  homeId      String?
  home        Home?   @relation(fields: [homeId], references: [id], onDelete: SetNull)

  workType    String
  workDate    DateTime
  description String?  @db.Text

  contractorId String
  contractor   User   @relation("ContractorWorkSubmissions", fields: [contractorId], references: [id], onDelete: Cascade)

  homeownerId String?
  homeowner   User?   @relation("HomeownerWorkSubmissions", fields: [homeownerId], references: [id], onDelete: SetNull)

  status WorkSubmissionStatus @default(PENDING_REVIEW)

  message String? @db.Text

  attachments Attachment[] @relation("WorkSubmissionAttachments")

  workRecord WorkRecord?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime?

  @@index([contractorId])
  @@index([homeownerId])
  @@index([homeId])
  @@index([status])
  @@index([createdAt])
}

model WorkRecord {
  id String @id @default(cuid())

  jobRequestId String?     @unique
  jobRequest   JobRequest? @relation("JobRequestRecord")

  submissionId String?         @unique
  submission   WorkSubmission? @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  homeId String
  home   Home   @relation(fields: [homeId], references: [id], onDelete: Cascade)

  contractorId String
  contractor   User   @relation("ContractorWorkRecords", fields: [contractorId], references: [id], onDelete: Cascade)

  addressSnapshot Json?

  workType    String
  workDate    DateTime
  description String?  @db.Text
  cost        Decimal? @db.Decimal(12, 2)

  attachments Attachment[] @relation("WorkRecordAttachments")
  invoiceUrl  String?
  photos      String[]     @default([])

  warrantyIncluded Boolean @default(false)
  warrantyLength   String?
  warrantyDetails  String? @db.Text

  status WorkSubmissionStatus @default(DOCUMENTED)

  isVerified Boolean   @default(false)
  claimedBy  String?
  claimedAt  DateTime?
  verifiedBy String?
  verifiedAt DateTime?

  approvedBy      String?
  approver        User?     @relation("WorkRecordApprovals", fields: [approvedBy], references: [id], onDelete: SetNull)
  approvedAt      DateTime?
  rejectionReason String?   @db.Text

  finalRecordId String? @unique
  finalRecord   Record? @relation("ApprovedWorkRecord", fields: [finalRecordId], references: [id], onDelete: SetNull)

  archivedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([homeId])
  @@index([contractorId])
  @@index([status])
  @@index([submissionId])
  @@index([createdAt])
  @@index([isVerified])
}

model Quote {
  id           String      @id @default(cuid())
  jobRequestId String?     @unique
  connectionId String
  homeId       String
  title        String
  description  String?     @db.Text
  totalAmount  Decimal     @db.Decimal(12, 2)
  status       QuoteStatus @default(DRAFT)
  expiresAt    DateTime?

  jobRequest JobRequest? @relation("JobRequestQuote")
  connection Connection  @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  home       Home        @relation(fields: [homeId], references: [id], onDelete: Cascade)
  items      QuoteItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([jobRequestId])
  @@index([connectionId])
  @@index([homeId])
  @@index([status])
}

model QuoteItem {
  id        String  @id @default(cuid())
  quoteId   String
  item      String
  qty       Decimal @db.Decimal(10, 2)
  unitPrice Decimal @db.Decimal(12, 2)
  total     Decimal @db.Decimal(12, 2)

  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
}

/**
 * =========================
 * Audit & Notifications
 * =========================
 */

model AuditLog {
  id        String   @id @default(cuid())
  actorId   String?
  homeId    String?
  entity    String
  entityId  String
  action    String
  diff      Json?
  createdAt DateTime @default(now())

  actor User? @relation("AuditActor", fields: [actorId], references: [id], onDelete: SetNull)
  home  Home? @relation("AuditHome", fields: [homeId], references: [id], onDelete: SetNull)

  @@index([entity, entityId, createdAt])
  @@index([homeId, createdAt])
}

model Notification {
  id        String              @id @default(cuid())
  userId    String
  channel   NotificationChannel
  subject   String
  payload   Json
  sentAt    DateTime?
  createdAt DateTime            @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

/**
 * =========================
 * NextAuth models
 * =========================
 */

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
